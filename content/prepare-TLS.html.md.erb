---
title: Preparing for Transport Layer Security (TLS)
---

 <!--
 Copyright (c) VMware, Inc. 2022. All rights reserved.
 Licensed to the Apache Software Foundation (ASF) under one or more contributor license
 agreements. See the NOTICE file distributed with this work for additional information regarding
 copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance with the License. You may obtain a
 copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software distributed under the License
 is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 or implied. See the License for the specific language governing permissions and limitations under
 the License.
 -->

This topic describes how to provide an existing Certificate Authority (CA) certificate to
[BOSH CredHub](https://docs.vmware.com/en/Tile-Developer-Guide/3.0/tile-dev-guide/credhub.html) and
how to generate a new CA certificate with BOSH CredHub.

<p class="note warning"><strong>WARNING</strong>: This procedure involves restarting all of the VMs in an existing VMware Tanzu Application Service for VMs (TAS for VMs) deployment in order to propagate a CA certificate. The operation can take a long time to complete.</p>

## <a id='overview'></a> Overview

Enabling TLS provisions VMware GemFire for Tanzu Application Service service instances with a certificate,
so that apps, gfsh, and Pulse can establish encrypted connections
with the GemFire for TAS service instance.

The certificate deployed on the GemFire for TAS service instance is a
**server certificate**.
The server certificate is generated by **CredHub**, a component designed for centralized credential management in TAS for VMs.
CredHub is deployed on the same VM as the BOSH Director.

CredHub generates the server certificate using a **Certificate Authority (CA) certificate**.
The CA certificate must be provided to CredHub by the operator or generated by CredHub.

Apps use the CA certificate to authenticate components of GemFire for TAS service instances.
Apps that communicate with GemFire for TAS must have access to the CA certificate
in order to validate that the server certificate can be trusted.

<p class="note warning"><strong>WARNING</strong>: An operator must rotate the CA certificate if it expires or if it becomes compromised.
To rotate your CA certificate, see <a href="rotating-ca.html">Managing Certificates</a>.
Do not attempt to rotate a CA certificate on your own.
Contact <%=vars.support_link%> and perform the procedure with their assistance.</p>

## <a id="provide-generate-pcf"></a> Provide or Generate a CA Certificate

TLS authorization requires a credential generated by CredHub. You do not need to create a new User
Account and Authentication (UAA) client for CredHub specifically to support TLS, as long as a UAA
Client exists with `credhub.write` and `credhub.read` permissions. The client used in this section is one that
was created during the Ops Manager installation process: the `ops_manager` client.

Perform the following steps to log in to CredHub and provide or generate a CA certificate:

1. From the Ops Manager VM, set the API target of the CredHub CLI to your CredHub server:

    ```
    credhub api https://BOSH-DIRECTOR:8844 --ca-cert=/var/tempest/workspaces/default/root_ca_certificate
    ```
    Where `BOSH-DIRECTOR` is the IP address of the BOSH Director VM.

    For example:
    <pre class="terminal">
    $ credhub api http<span>s:</span>//10.0.0.5:8844 --ca-cert=/var/tempest/workspaces/default/root_ca_certificate
    </pre>

1. Log in to CredHub:

    ```
    credhub login --client-name=CLIENT-NAME --client-secret=CLIENT-SECRET
    ```
    Where:
    * `CLIENT-NAME` is the client name, usually `ops_manager` or a CredHub-specific UAA client of your own creation.
    * `CLIENT-SECRET` is the client secret. Locate this under the Credentials tab of the Ops Manager tile with the name `Bosh Commandline Credentials`.

    For example:
    <pre class="terminal">
    $ credhub login \
        --client-name=ops_manager \
        --client-secret=abcdefghijklm123456789
    </pre>

1. Use the CredHub CLI to check whether a services CA certificate already is present:

    ```
    credhub get --name="/services/tls_ca"
    ```
    If you already have a certificate at the `services/tls_ca` path, skip to step 5.

1. Use the CredHub CLI to generate a CA certificate or provide an existing one.
    <p class="note"><strong>Note</strong>: Your deployment may have multiple CA certificates.
    VMware recommends that you use a dedicated CA certificate for services.</p>

    * If you do not have a CA certificate, use the CredHub CLI to generate one:

        ```
        credhub generate \
        --name="/services/tls_ca" \
        --type="certificate" \
        --no-overwrite \
        --is-ca \
        --common-name="rootCA"
        ```

    * If you have an existing CA certificate that you want to use, create a new file named `root.pem` with the contents of the certificate. Then enter the following command, specifying the path to `root.pem` and the private key for the certificate:

        ```
        credhub set \
        --name="/services/tls_ca" \
        --type="certificate" \
        --certificate=./root.pem \
        --private=ERKSOSMFF...
        ```

1. Use the BOSH CLI v2 to extract the `certificate` portion from the CA certificate and print it:

    ```
    bosh interpolate <(credhub get --name=/services/tls_ca) \
    --path=/value/certificate
    ```

1. Record the output of the `bosh interpolate` command.

## <a id='add-ca-cert-bosh'></a> Add the CA Certificate to Ops Manager

Add the CA certificate to Ops Manager by adding it to the BOSH Director tile and the Tanzu Application Service tile.

### Add the CA certificate to the BOSH Director tile:

1. Navigate to the Ops Manager **Installation Dashboard** and select the **Bosh Director** tile.
Click **Security**.

1. Copy and paste the contents of the CA certificate into **Trusted Certificates**.
If Trusted Certificates are already listed, append the new certificate to the existing content.
![Security: Trusted Certificates](./images/security-pane-trusted-certs.png)

1. Check **Include Tanzu Ops Manager Root CA in Trusted Certs** to place the Tanzu Ops Manager Root CA into the trusted certificate field. The
BOSH Director then places this CA into the truststore of every VM that it deploys.
![Security: Include Trusted](./images/security-pane-include-trusted.png)

1. For **Generate VM passwords or use single password for all VMs**, select **Generate passwords** or **Use default BOSH password**, depending on your implementation needs.
![Security: Generate VM passwords](./images/security-pane-generate-pw.png)

1. Click **Save**.

### Add the CA certificate to the Tanzu Application Service tile

1. The CA certificate must also be added for the Gorouter.
Navigate to the TAS tile's **Settings** tab.

1. Click on **Networking**. Add the CA certificate to the box labeled **Certificate Authorities Trusted by Gorouter**.<br />
  ![Networking: CA Gorouter](./images/tas-networking-ca-gorouter.png)

1. Scroll down and add the CA certificate to the box labeled **Certificate Authorities trusted by the HAProxy**.<br />
  ![Networking: CA HA Proxy](./images/tas-networking-ca-haproxy.png)

1. Click **Save**.

## Save Your Changes

1.  Return to the Installation Dashboard.
1.  Click **Review Pending Changes**. For more information, see [Reviewing Your Pending Product Changes in Tanzu Operations Manager](https://docs.vmware.com/en/VMware-Tanzu-Operations-Manager/3.0/vmware-tanzu-ops-manager/install-review-pending-changes.html) in the VMware Tanzu Operarations Manager documentation.
1.  Click **Apply Changes**.

